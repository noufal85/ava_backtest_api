openapi: "3.0.3"
info:
  title: Trading Backtester V2 API
  version: "2.0.0"
  description: |
    Professional quantitative trading research platform.
    All endpoints are prefixed with `/api/v2`. WebSocket endpoint at `/ws`.

servers:
  - url: http://localhost:8000
    description: Local development

tags:
  - name: Backtests
  - name: Strategies
  - name: Universes
  - name: Data
  - name: Analytics

# --------------------------------------------------------------------------
paths:
  # ---- Backtests ----
  /api/v2/backtests:
    get:
      tags: [Backtests]
      summary: List backtests
      parameters:
        - name: status
          in: query
          schema: { type: string, enum: [pending, running, completed, failed, cancelled] }
        - name: strategy
          in: query
          schema: { type: string }
        - name: limit
          in: query
          schema: { type: integer, default: 50 }
        - name: offset
          in: query
          schema: { type: integer, default: 0 }
      responses:
        "200":
          description: Paginated list of backtests
          content:
            application/json:
              schema:
                type: object
                properties:
                  items: { type: array, items: { $ref: "#/components/schemas/BacktestSummary" } }
                  total: { type: integer }
              example:
                total: 42
                items:
                  - id: "a1b2c3d4-0000-0000-0000-000000000001"
                    strategy_name: "ema_crossover"
                    status: "completed"
                    created_at: "2025-06-01T10:00:00Z"
                    total_return_pct: 18.45
    post:
      tags: [Backtests]
      summary: Create & queue a new backtest
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/CreateBacktestRequest" }
            example:
              strategy_name: "ema_crossover"
              strategy_version: "2.0.0"
              parameters:
                fast_period: 9
                slow_period: 21
              universe: "sp500_liquid"
              start_date: "2020-01-01"
              end_date: "2024-12-31"
              initial_capital: 100000
      responses:
        "201":
          description: Backtest created
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Backtest" }

  /api/v2/backtests/{id}:
    get:
      tags: [Backtests]
      summary: Get backtest detail with metrics
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        "200":
          description: Full backtest with result metrics
          content:
            application/json:
              schema: { $ref: "#/components/schemas/BacktestDetail" }
        "404":
          description: Not found

  /api/v2/backtests/{id}/trades:
    get:
      tags: [Backtests]
      summary: List trades for a backtest
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
        - name: symbol
          in: query
          schema: { type: string }
        - name: direction
          in: query
          schema: { type: string, enum: [long, short] }
        - name: limit
          in: query
          schema: { type: integer, default: 200 }
        - name: offset
          in: query
          schema: { type: integer, default: 0 }
      responses:
        "200":
          description: Paginated trade list
          content:
            application/json:
              schema:
                type: object
                properties:
                  items: { type: array, items: { $ref: "#/components/schemas/Trade" } }
                  total: { type: integer }

  /api/v2/backtests/{id}/equity-curve:
    get:
      tags: [Backtests]
      summary: Equity curve data points
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
        - name: resample
          in: query
          description: "Resample period: 'D' (daily), 'W', 'M'"
          schema: { type: string, default: "D" }
      responses:
        "200":
          description: Array of date/equity pairs
          content:
            application/json:
              schema:
                type: object
                properties:
                  points:
                    type: array
                    items:
                      type: object
                      properties:
                        date: { type: string, format: date }
                        equity: { type: number }
                        drawdown_pct: { type: number }
              example:
                points:
                  - { date: "2020-01-02", equity: 100000, drawdown_pct: 0 }
                  - { date: "2020-01-03", equity: 100250, drawdown_pct: 0 }

  # ---- Strategies ----
  /api/v2/strategies:
    get:
      tags: [Strategies]
      summary: List all registered strategies
      responses:
        "200":
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/StrategySummary" }

  /api/v2/strategies/{name}:
    get:
      tags: [Strategies]
      summary: Strategy detail with parameter schema
      parameters:
        - name: name
          in: path
          required: true
          schema: { type: string }
        - name: version
          in: query
          schema: { type: string, default: "latest" }
      responses:
        "200":
          content:
            application/json:
              schema: { $ref: "#/components/schemas/StrategyDetail" }

  /api/v2/strategies/{name}/backtest:
    post:
      tags: [Strategies]
      summary: Shortcut â€” run a backtest for this strategy
      parameters:
        - name: name
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: "#/components/schemas/RunStrategyBacktestRequest" }
      responses:
        "201":
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Backtest" }

  # ---- Universes ----
  /api/v2/universes:
    get:
      tags: [Universes]
      summary: List defined universes
      responses:
        "200":
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Universe" }

  # ---- Data ----
  /api/v2/data/candles:
    get:
      tags: [Data]
      summary: Query candle data
      parameters:
        - name: symbol
          in: query
          required: true
          schema: { type: string }
        - name: timeframe
          in: query
          schema: { type: string, default: "1d", enum: ["1m","5m","15m","1h","1d"] }
        - name: start
          in: query
          required: true
          schema: { type: string, format: date }
        - name: end
          in: query
          required: true
          schema: { type: string, format: date }
      responses:
        "200":
          content:
            application/json:
              schema:
                type: object
                properties:
                  symbol: { type: string }
                  timeframe: { type: string }
                  candles:
                    type: array
                    items: { $ref: "#/components/schemas/Candle" }

  # ---- Analytics ----
  /api/v2/analytics/correlation:
    get:
      tags: [Analytics]
      summary: Cross-strategy return correlation matrix
      parameters:
        - name: backtest_ids
          in: query
          required: true
          schema: { type: array, items: { type: string, format: uuid } }
      responses:
        "200":
          content:
            application/json:
              schema:
                type: object
                properties:
                  labels: { type: array, items: { type: string } }
                  matrix: { type: array, items: { type: array, items: { type: number } } }

  /api/v2/analytics/portfolio:
    get:
      tags: [Analytics]
      summary: Combined portfolio metrics for multiple backtests
      parameters:
        - name: backtest_ids
          in: query
          required: true
          schema: { type: array, items: { type: string, format: uuid } }
        - name: weights
          in: query
          description: "Allocation weights (same order as backtest_ids). Default: equal weight."
          schema: { type: array, items: { type: number } }
      responses:
        "200":
          content:
            application/json:
              schema: { $ref: "#/components/schemas/PortfolioMetrics" }

# --------------------------------------------------------------------------
# WebSocket (documented as x- extension; not natively representable in OAS 3.0)
x-websocket-endpoints:
  /ws/backtests/{id}:
    description: |
      Real-time backtest progress. Server pushes JSON frames:
      ```json
      {"type":"progress","pct":42.5,"current_symbol":"AAPL","symbols_done":85,"symbols_total":200}
      {"type":"completed","backtest_id":"...","sharpe":1.45,"total_return_pct":22.3}
      {"type":"error","message":"Out of memory"}
      ```

# --------------------------------------------------------------------------
components:
  schemas:
    BacktestSummary:
      type: object
      properties:
        id: { type: string, format: uuid }
        strategy_name: { type: string }
        strategy_version: { type: string }
        universe_name: { type: string }
        status: { type: string }
        total_return_pct: { type: number, nullable: true }
        sharpe_ratio: { type: number, nullable: true }
        created_at: { type: string, format: date-time }
        duration_seconds: { type: number, nullable: true }

    Backtest:
      type: object
      properties:
        id: { type: string, format: uuid }
        strategy_name: { type: string }
        strategy_version: { type: string }
        param_yaml: { type: string }
        universe_name: { type: string }
        start_date: { type: string, format: date }
        end_date: { type: string, format: date }
        initial_capital: { type: number }
        status: { type: string }
        created_at: { type: string, format: date-time }

    BacktestDetail:
      allOf:
        - $ref: "#/components/schemas/Backtest"
        - type: object
          properties:
            results:
              $ref: "#/components/schemas/BacktestResults"

    BacktestResults:
      type: object
      properties:
        total_return_pct: { type: number }
        cagr_pct: { type: number }
        sharpe_ratio: { type: number }
        sortino_ratio: { type: number }
        calmar_ratio: { type: number }
        max_drawdown_pct: { type: number }
        max_drawdown_days: { type: integer }
        win_rate_pct: { type: number }
        profit_factor: { type: number }
        total_trades: { type: integer }
        avg_hold_days: { type: number }
        final_equity: { type: number }
        monthly_returns: { type: object }

    CreateBacktestRequest:
      type: object
      required: [strategy_name, universe, start_date, end_date, initial_capital]
      properties:
        strategy_name: { type: string }
        strategy_version: { type: string, default: "latest" }
        parameters: { type: object }
        universe: { type: string }
        start_date: { type: string, format: date }
        end_date: { type: string, format: date }
        initial_capital: { type: number }
        sizing: { type: object }
        risk_rules: { type: array, items: { type: object } }
        regime_filter: { type: object }

    RunStrategyBacktestRequest:
      type: object
      required: [universe, start_date, end_date, initial_capital]
      properties:
        parameters: { type: object }
        universe: { type: string }
        start_date: { type: string, format: date }
        end_date: { type: string, format: date }
        initial_capital: { type: number }

    Trade:
      type: object
      properties:
        id: { type: string, format: uuid }
        symbol: { type: string }
        direction: { type: string, enum: [long, short] }
        entry_date: { type: string, format: date }
        entry_price: { type: number }
        exit_date: { type: string, format: date, nullable: true }
        exit_price: { type: number, nullable: true }
        shares: { type: integer }
        pnl: { type: number, nullable: true }
        pnl_pct: { type: number, nullable: true }
        hold_days: { type: integer, nullable: true }
        exit_reason: { type: string, nullable: true }

    Candle:
      type: object
      properties:
        ts: { type: string, format: date-time }
        open: { type: number }
        high: { type: number }
        low: { type: number }
        close: { type: number }
        volume: { type: integer }

    StrategySummary:
      type: object
      properties:
        name: { type: string }
        latest_version: { type: string }
        description: { type: string }
        tags: { type: array, items: { type: string } }
        is_active: { type: boolean }

    StrategyDetail:
      type: object
      properties:
        name: { type: string }
        version: { type: string }
        description: { type: string }
        tags: { type: array, items: { type: string } }
        default_config: { type: object }
        parameter_schema:
          type: object
          description: JSON Schema describing accepted parameters
        required_timeframes: { type: array, items: { type: string } }
        warmup_periods: { type: integer }
        changelog: { type: string }

    Universe:
      type: object
      properties:
        id: { type: string, format: uuid }
        name: { type: string }
        description: { type: string }
        type: { type: string, enum: [static, filter, index] }
        symbol_count: { type: integer }

    PortfolioMetrics:
      type: object
      properties:
        combined_return_pct: { type: number }
        combined_sharpe: { type: number }
        combined_max_drawdown_pct: { type: number }
        diversification_ratio: { type: number }
        weights: { type: object }
        equity_curve:
          type: array
          items:
            type: object
            properties:
              date: { type: string, format: date }
              equity: { type: number }
